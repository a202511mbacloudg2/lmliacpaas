# Executa o pipeline em todo commit na branch main
trigger:
- main

pool:
  name: agentPoolPucMinas # Nome do agent pool
  demands:
    - Agent.Name -equals mac-agent-pucminas-01  # Força o uso do agente específico
  vmImage: 'windows-latest'

variables:
  resourceGroupName: rg-iac-webapp-paas
  location: centralus
  templateFile: arm-templates/webapp-template.json
  parametersFile: arm-templates/webapp-parameters.json
   # Nome da VM a ser criado pelo ARM
  vmName: 'vm-iac-web-iis-paas'

stages:
- stage: DeployInfrastructure
  jobs:
  - job: ARM_Deployment
    steps:
    - task: AzureResourceManagerTemplateDeployment@3
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: 'ar01com'
        subscriptionId: '4b8fff8d-5bef-4989-b149-f795bb6d4a4e'
        action: 'Create Or Update Resource Group'
        resourceGroupName: '$(resourceGroupName)'
        location: '$(location)'
        templateLocation: 'Linked artifact'
        csmFile: '$(templateFile)'
        csmParametersFile: '$(parametersFile)'
        deploymentMode: 'Incremental'

- stage: DeployApp
  dependsOn: DeployInfrastructure
  jobs:
  - job: Publish_HTML
    steps:
    - task: AzureWebApp@1
      inputs:
        azureSubscription: 'ar01com'
        appType: 'webApp'
        appName: 'lmliacpaas001'
        package: 'src'